generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public", "auth"]

}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model activity_logs {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String?   @db.Uuid
  user_name   String?   @default("System") @db.VarChar(255)
  action      String    @db.VarChar(50)
  entity_type String    @db.VarChar(50)
  entity_id   String?   @db.Uuid
  description String
  old_data    Json?
  new_data    Json?
  ip_address  String?   @db.VarChar(45)
  user_agent  String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@index([action], map: "idx_logs_action")
  @@index([created_at(sort: Desc)], map: "idx_logs_date")
  @@index([entity_type, entity_id], map: "idx_logs_entity")
  @@index([user_id], map: "idx_logs_user")
  @@schema("public")

}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model payments {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id String     @db.Uuid
  month      Int
  year       Int
  amount     Decimal    @default(0) @db.Decimal(12, 2)
  is_paid    Boolean    @default(false)
  paid_at    DateTime?  @db.Timestamptz(6)
  created_at DateTime?  @default(now()) @db.Timestamptz(6)
  updated_at DateTime?  @default(now()) @db.Timestamptz(6)
  students   students   @relation(fields: [student_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  finances   finances[]

  @@unique([student_id, month, year])
  @@index([year, month], map: "idx_payments_period")
  @@index([is_paid], map: "idx_payments_status")
  @@index([student_id], map: "idx_payments_student")
  @@schema("public")
}

model settings {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String    @unique @db.VarChar(100)
  value       String
  description String?   @db.VarChar(255)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  @@schema("public")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model students {
  id                 String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String               @db.VarChar(255)
  class              String               @db.VarChar(20)
  year_enrolled      Int
  status             String               @default("active") @db.VarChar(20)
  created_at         DateTime?            @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?            @default(now()) @db.Timestamptz(6)
  payments           payments[]
  tabungan           tabungan?            @relation("StudentTabungan")
  tabungan_transaksi tabungan_transaksi[] @relation("StudentTabunganTransaksi")
  has_tabungan       Boolean              @default(false)


  @@index([class], map: "idx_students_class")
  @@index([name], map: "idx_students_name")
  @@index([status], map: "idx_students_status")
  @@index([year_enrolled], map: "idx_students_year")
  @@schema("public")
}

model tabungan {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id       String    @unique @db.Uuid
  saldo            Decimal   @default(0) @db.Decimal(12, 2)
  jumlah_transaksi Int       @default(0)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)
  students         students  @relation("StudentTabungan", fields: [student_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  @@schema("public")
}

model tabungan_transaksi {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id    String    @db.Uuid
  tanggal       DateTime  @default(now()) @db.Timestamptz(6)
  jenis         String    @db.VarChar(10)
  nominal       Decimal   @db.Decimal(12, 2)
  keterangan    String?
  saldo_setelah Decimal?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  students      students  @relation("StudentTabunganTransaksi", fields: [student_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  @@schema("public")
}

/// School finances - income and expenses (auto-synced from payments via database trigger)
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model finances {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date        DateTime  @db.Timestamptz(6)
  type        String    @db.VarChar(20) // 'income' or 'expense'
  amount      Decimal   @db.Decimal(12, 2)
  description String?
  payment_id  String?   @db.Uuid
  payments    payments? @relation(fields: [payment_id], references: [id], onDelete: Cascade)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@index([date], map: "idx_finances_date")
  @@index([type], map: "idx_finances_type")
  @@index([payment_id], map: "idx_finances_payment_id")
  @@schema("public")
}
